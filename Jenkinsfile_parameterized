#!groovy
properties([
        parameters([
                string(name: 'PRODUCT_NAME', defaultValue: 'finrem-ccd', description: 'Financial Remedy Application'),
                string(name: 'APP', defaultValue: 'cos', description:  'Financial Remedy Case Orchestration Service'),
                choice(name: 'JourneyType', choices: 'test-e2e\ne2eHwfJourney\ne2ePbaJourney', description: 'Different journeys to build in')
        ]),
        [$class: 'GithubProjectProperty', projectUrlStr: 'https://github.com/hmcts/finrem-ccd-e2e-tests.git'],
        pipelineTriggers([[$class: 'GitHubPushTrigger']])
])

@Library("Infrastructure")

def product = "finrem-ccd"
def component = "e2e"


withParameterizedPipeline("nodejs", params.PRODUCT_NAME, params.APP, params.JourneyType)
 {
        ws('workspace/finrem-ccd-e2e-tests') {
            stage('Checkout') {
                deleteDir()
                checkout scm
            }

            stage('Journey Tests') {
                try {
                    if  (params.JourneyType == 'test-e2e') {
                        sh 'yarn install'
                        sh 'yarn test-e2e'
                    }
                    else if(params.JourneyType == 'e2eHwfJourney')

                    {
                        sh 'yarn install'
                        sh 'yarn e2eHwfJourney'
                    }
                    else if (params.JourneyType == 'e2ePbaJourney')

                    {
                        sh 'yarn install'
                        sh 'yarn e2ePbaJourney'
                    }
                }
                catch (Exception err) {
                    currentBuild.result = 'UNSTABLE'
                    echo "RESULT: ${currentBuild.result}"
                } finally {
                    sh 'ls -lart'
                    sh 'ls -lrt ./functional-output'
                    archiveArtifacts 'functional-output/*'

                }

            }

            stage('After run') {
                echo "finished"
            }

        }
        deleteDir()
}